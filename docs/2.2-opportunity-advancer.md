# Process 2.2: Opportunity Advancer - Claude Code Mirror

**Status:** üöß Em Especifica√ß√£o
**Prioridade:** 0 (Foundation)
**Tempo Estimado:** 2-3 horas

---

## Objetivo

Criar vers√£o Claude Code do agente **Opportunity Advancer** que j√° existe no My Notion AI, validando a abordagem h√≠brida e estabelecendo padr√µes para futuros agentes.

## Contexto

O Opportunity Advancer (Process 2.2) √© o agente mais cr√≠tico do workflow de CRM:
- **Fun√ß√£o:** Ap√≥s cada reuni√£o com cliente, atualizar 5 campos da oportunidade automaticamente
- **Status no Notion:** ‚úÖ Operacional desde 2025-11-18
- **Comando Notion:** `"Atualize o avan√ßo da oportunidade [Nome]"`
- **Valor:** Garante que pipeline sempre avan√ßa ap√≥s intera√ß√µes, com esfor√ßo m√≠nimo

**Por que criar espelho Claude Code?**
1. ‚úÖ Versionamento (Git) - rastrear mudan√ßas na l√≥gica do agente
2. ‚úÖ Testing - validar comportamento antes de deploy no Notion
3. ‚úÖ Logging - entender decis√µes do agente
4. ‚úÖ Foundation - aprender padr√µes para pr√≥ximos agentes

---

## Input Specification

### Required Input

**Nome da Oportunidade** (string)
- Exemplo: `"Projeto SiDi - Nova Plataforma"`
- Usado para query no database Oportunidades

### Optional Flags

- `--dry-run`: Mostra output sem atualizar Notion (default: true)
- `--verbose`: Mostra detalhes do processamento (queries, parsing, decis√µes)
- `--format`: Output format (`markdown` | `json`)

### Comando CLI (Proposto)

```bash
# Dry-run (s√≥ mostra resultado, n√£o atualiza)
claude-code advance-opportunity "Projeto SiDi"

# Atualizar de verdade (pede confirma√ß√£o)
claude-code advance-opportunity "Projeto SiDi" --execute

# Verbose mode
claude-code advance-opportunity "Projeto SiDi" --verbose
```

---

## Processing Logic

### Step 1: Query Oportunidade

**Objetivo:** Encontrar oportunidade no Notion por nome

**MCP Tool:** `mcp__notion__notion-search`

**Query:**
```
query: "nome_da_oportunidade"
query_type: "internal"
data_source_url: "collection://201b1882-308d-4524-8a86-6672d5502299"
```

**Success Criteria:**
- Exatamente 1 resultado encontrado
- Se 0 resultados ‚Üí Error: "Oportunidade n√£o encontrada"
- Se >1 resultado ‚Üí Pedir user escolher qual

**Output:** Opportunity page URL

---

### Step 2: Fetch Opportunity Properties

**Objetivo:** Carregar properties atuais da oportunidade

**MCP Tool:** `mcp__notion__notion-fetch`

**Query:**
```
id: opportunity_page_url
```

**Properties to Extract:**
- `Task` (t√≠tulo da oportunidade)
- `Biz Funnel` (current stage)
- `Status` (current status)
- `Priority` (High/Medium/Low)
- `Update Log` (√∫ltima entrada)
- `Next Action` (current)
- `Next Action Date` (current)
- `Anota√ß√µes` (relation URLs array)
- `Offline Notes` (rich text)

**Success Criteria:**
- Page loaded com todas properties
- Se Anota√ß√µes est√° vazio E Offline Notes est√° vazio ‚Üí Error: "Sem dados de reuni√£o para processar"

---

### Step 3: Load Most Recent Meeting Notes

**Objetivo:** Identificar e carregar anota√ß√£o mais recente

**MCP Tool:** `mcp__notion__notion-fetch` (para cada URL em Anota√ß√µes)

**Logic:**
```python
# Pseudo-code
anotacoes = []
for url in opportunity.anotacoes:
    page = fetch(url)
    anotacoes.append({
        'url': url,
        'title': page.title,
        'date': extract_date_from_title(page.title),  # "@Today 11:11 AM (GMT-3)"
        'date_property': page.properties.Date,
        'transcript': extract_content(page.content, '<transcript>'),
        'summary': extract_content(page.content, '<summary>'),
        'notes': extract_content(page.content, '<notes>')
    })

# Sort by date (most recent first)
anotacoes_sorted = sort_by_date(anotacoes, descending=True)

# Get most recent
most_recent = anotacoes_sorted[0]
```

**Date Extraction Logic:**
- Primary: `Date` property (if exists)
- Fallback: Parse title format `@Today 11:11 AM (GMT-3)` or `@DD/MM HH:MM AM/PM`
- Last resort: Created timestamp

**Content Sources (Priority Order):**
1. `<transcript>` tag content (full meeting transcript)
2. `<summary>` tag content (AI-generated summary)
3. `<notes>` tag content (user notes)
4. Offline Notes field (se Anota√ß√µes vazias)

**Success Criteria:**
- Pelo menos 1 fonte de conte√∫do dispon√≠vel
- Data da √∫ltima intera√ß√£o identificada

---

### Step 4: Analyze Meeting Content

**Objetivo:** Extrair insights e gerar 5 campos

**AI Processing:** Use Claude's analysis capabilities

**Analysis Prompt Template:**

```markdown
You are analyzing a business meeting to update a CRM opportunity.

## Context
- **Opportunity:** {opportunity.Task}
- **Current Biz Funnel Stage:** {opportunity.Biz_Funnel}
- **Current Status:** {opportunity.Status}
- **Priority:** {opportunity.Priority}
- **Last Update Log:** {opportunity.Update_Log (√∫ltima entrada)}

## Meeting Content
**Date:** {meeting.date}
**Transcript:** {meeting.transcript}
**Summary:** {meeting.summary}
**Notes:** {meeting.notes}
**Offline Notes:** {opportunity.Offline_Notes}

## Task
Based on the meeting content above, generate the following 5 fields:

### 1. Update Log (1 concise sentence, max 10 words)
Format: `DD/MM: [key action or result]`
Example: `18/11: cliente aprovou proposta t√©cnica`
Rules:
- Focus on KEY decision, action, or result
- Not a full summary, just the most important thing
- Use date of this meeting

### 2. Next Action (clear objective action)
Format: Verb + object + minimal context
Example: `Enviar proposta comercial revisada`
Rules:
- Actionable by user (not waiting on client)
- Specific enough to know what to do
- If waiting on client, use Status = "Waiting Feedback" instead

### 3. Next Action Date (when to act)
Rules:
- Based on: meeting urgency, client deadlines, proposal timelines
- Default: Last interaction date + 7 calendar days
- If client gave specific deadline, use that
- Format: YYYY-MM-DD

### 4. Biz Funnel (detect stage progression?)
Current stage: {opportunity.Biz_Funnel}
Stages (in order):
1. Marketing
2. Suspect
3. Prospect
4. Contato
5. Credibilidade
6. Oferta
7. Proposta
8. Negocia√ß√£o
9. Fechamento
10. Relacionamento
11. done!

Advancement signals:
- Credibilidade ‚Üí Oferta: Client wants to know pricing/proposal
- Oferta ‚Üí Proposta: Client requested formal proposal
- Proposta ‚Üí Negocia√ß√£o: Client negotiating terms/price
- Negocia√ß√£o ‚Üí Fechamento: Client confirmed purchase/signed contract

Rules:
- If clear advancement signal detected ‚Üí suggest new stage
- If no clear signal ‚Üí keep current stage
- Never skip stages (e.g., can't go Credibilidade ‚Üí Proposta)
- User will confirm stage changes (you just suggest)

### 5. Status (blocked or moving?)
Options:
- `In progress`: User has action to take
- `Waiting Feedback`: Awaiting client response (no action for user now)
- `Scheduled`: Next action has scheduled date/time

Rules:
- If Next Action is something user must do ‚Üí "In progress"
- If waiting on client decision/response ‚Üí "Waiting Feedback"
- If next meeting is scheduled ‚Üí "Scheduled"

## Output Format
Return ONLY a JSON object with these 5 fields:

```json
{
  "update_log": "DD/MM: [one sentence]",
  "next_action": "[verb + object]",
  "next_action_date": "YYYY-MM-DD",
  "biz_funnel": "[current stage]" or "[suggested new stage]",
  "biz_funnel_changed": true/false,
  "biz_funnel_reasoning": "if changed, explain why in 1 sentence",
  "status": "In progress" | "Waiting Feedback" | "Scheduled"
}
```
```

**Success Criteria:**
- JSON v√°lido retornado
- Todos os 5 campos preenchidos
- Update Log <= 10 palavras
- Next Action √© acion√°vel
- Biz Funnel est√° na lista de stages v√°lidos

---

### Step 5: Generate Output Report

**Objetivo:** Apresentar resultado para user valida√ß√£o

**Output Format (Markdown):**

```markdown
# Opportunity Update: {Opportunity Name}

**Last Interaction:** {meeting.date}
**Current Stage:** {current_biz_funnel} ‚Üí {suggested_biz_funnel (if changed)}
**Priority:** {priority}

---

## Proposed Updates

### 1. Update Log
```
{proposed.update_log}
```

**Current:** {current.update_log (primeira linha)}

### 2. Next Action
```
{proposed.next_action}
```

**Current:** {current.next_action}

### 3. Next Action Date
```
{proposed.next_action_date}
```

**Current:** {current.next_action_date}
**Rationale:** Last interaction + 7 days (or client deadline if mentioned)

### 4. Biz Funnel Stage
```
{proposed.biz_funnel}
```

**Current:** {current.biz_funnel}
**Changed:** {yes/no}
{if changed: **Reasoning:** {biz_funnel_reasoning}}

### 5. Status
```
{proposed.status}
```

**Current:** {current.status}

---

## Meeting Context Analyzed

**Transcript excerpt:** {first 200 chars of transcript...}
**Summary:** {summary}
**Key Decisions:** {extracted from analysis}

---

## Next Steps

{if dry-run mode:}
This is a DRY RUN. No changes will be made to Notion.

To apply these changes, run:
`claude-code advance-opportunity "{opportunity_name}" --execute`

{if execute mode:}
Do you want to apply these updates to Notion? (yes/no)
```

---

## Update Execution (if --execute flag)

### Step 6: User Confirmation

**Prompt:**
```
Apply these updates to Notion?
[Y]es / [N]o / [E]dit / [S]kip field
```

**Options:**
- `Y`: Proceed with update
- `N`: Cancel, do not update
- `E`: Open interactive editor to adjust fields
- `S`: Skip specific fields (e.g., "skip biz_funnel" if user disagrees)

### Step 7: Update Notion via MCP

**MCP Tool:** `mcp__notion__notion-update-page`

**Update Command:**
```json
{
  "page_id": "{opportunity_page_id}",
  "command": "update_properties",
  "properties": {
    "Update Log": "{append_with_newline: proposed.update_log}",
    "Next Action": "{proposed.next_action}",
    "date:Next Action Date:start": "{proposed.next_action_date}",
    "date:Next Action Date:is_datetime": 0,
    "Biz Funnel": "{proposed.biz_funnel}",
    "Status": "{proposed.status}"
  }
}
```

**Note:** Update Log deve APPEND (n√£o replace). Formato:
```
{proposed.update_log}
{existing.update_log}
```

**Success Criteria:**
- Update returns 200 OK
- Properties s√£o refletidas no Notion

### Step 8: Confirmation Output

```markdown
‚úÖ Opportunity updated successfully!

View in Notion: {opportunity_url}

**Updated fields:**
- Update Log: ‚úÖ
- Next Action: ‚úÖ
- Next Action Date: ‚úÖ
- Biz Funnel: {‚úÖ or ‚è≠Ô∏è skipped}
- Status: ‚úÖ

**Next:** {proposed.next_action} by {proposed.next_action_date}
```

---

## Error Handling

### Common Errors

| Error | Cause | Recovery |
|-------|-------|----------|
| `OpportunityNotFound` | Nome n√£o encontrado no database | Suggest similar names (fuzzy match) |
| `MultipleOpportunitiesFound` | >1 resultado com mesmo nome | Show list, ask user to choose |
| `NoMeetingData` | Anota√ß√µes vazio E Offline Notes vazio | Error: "No meeting data to process" |
| `InvalidDate` | N√£o consegue extrair data da anota√ß√£o | Usar created timestamp como fallback |
| `AIProcessingError` | Claude n√£o retornou JSON v√°lido | Retry 1x, se falhar pedir user input |
| `NotionUpdateError` | MCP update falhou | Log error, rollback se poss√≠vel |

### Logging

**Create `logs/` folder**

**Log Format:** `logs/opportunity-advancer-{timestamp}.log`

**Log Contents:**
```
[YYYY-MM-DD HH:MM:SS] INFO: Starting Opportunity Advancer
[YYYY-MM-DD HH:MM:SS] INFO: Querying opportunity: "Projeto SiDi"
[YYYY-MM-DD HH:MM:SS] DEBUG: Found 1 result: {url}
[YYYY-MM-DD HH:MM:SS] INFO: Loading properties...
[YYYY-MM-DD HH:MM:SS] DEBUG: Properties: {json dump}
[YYYY-MM-DD HH:MM:SS] INFO: Loading 3 Anota√ß√µes...
[YYYY-MM-DD HH:MM:SS] DEBUG: Most recent: {date} - {title}
[YYYY-MM-DD HH:MM:SS] INFO: Analyzing meeting content...
[YYYY-MM-DD HH:MM:SS] DEBUG: AI Response: {json}
[YYYY-MM-DD HH:MM:SS] INFO: Generated 5 fields successfully
[YYYY-MM-DD HH:MM:SS] INFO: User confirmed update
[YYYY-MM-DD HH:MM:SS] INFO: Updating Notion...
[YYYY-MM-DD HH:MM:SS] INFO: ‚úÖ Success! Opportunity updated.
```

---

## Testing Plan

### Test Cases

#### Test Case 1: Standard Update (Happy Path)
- **Oportunidade:** {escolher uma real com reuni√£o recente}
- **Expected:** Todos 5 campos gerados corretamente
- **Validation:** Comparar com output do Notion AI (se dispon√≠vel)

#### Test Case 2: Stage Advancement
- **Oportunidade:** {uma que claramente avan√ßou de stage}
- **Expected:** biz_funnel_changed = true, reasoning v√°lido

#### Test Case 3: Waiting on Client
- **Oportunidade:** {uma onde est√° aguardando cliente}
- **Expected:** Status = "Waiting Feedback", Next Action n√£o √© a√ß√£o do user

#### Test Case 4: Offline Notes Only
- **Oportunidade:** {uma sem Anota√ß√µes mas com Offline Notes}
- **Expected:** Processar Offline Notes como fonte

#### Test Case 5: Multiple Anota√ß√µes
- **Oportunidade:** {uma com 5+ anota√ß√µes}
- **Expected:** Identificar corretamente a mais recente

### Acceptance Criteria

**Para considerar Fase 0 conclu√≠da:**
- [ ] Agent processa 5/5 test cases com sucesso
- [ ] Output √© consistente com Notion AI (>80% match)
- [ ] Tempo de execu√ß√£o < 30 segundos
- [ ] User consegue validar e aplicar updates facilmente
- [ ] Logs s√£o √∫teis para debug
- [ ] Error handling funciona para casos comuns

---

## Future Enhancements (Fora de Escopo Fase 0)

1. **Auto-detect new Anota√ß√µes:** Polling ou webhook para executar automaticamente
2. **Batch processing:** Processar m√∫ltiplas oportunidades de uma vez
3. **Learning from corrections:** Track quando user edita output, aprender padr√µes
4. **Integration with Notion AI:** Sincronizar l√≥gica entre ambos agents
5. **Confidence scores:** Mostrar confian√ßa em cada campo (Low/Medium/High)

---

## Implementation Checklist

### Pre-Implementation
- [ ] Review esta spec completamente
- [ ] Validar que MCP tools est√£o dispon√≠veis (`mcp__notion__notion-search`, `fetch`, `update-page`)
- [ ] Decidir: Python ou TypeScript? (Recomenda√ß√£o: use Claude Code capabilities diretamente)

### Implementation (Core)
- [ ] Setup project structure (`agents/`, `logs/`)
- [ ] Implement Step 1: Query Oportunidade
- [ ] Implement Step 2: Fetch Properties
- [ ] Implement Step 3: Load Most Recent Anota√ß√µes
- [ ] Implement Step 4: AI Analysis
- [ ] Implement Step 5: Generate Output Report

### Implementation (Execution)
- [ ] Implement Step 6: User Confirmation
- [ ] Implement Step 7: Update Notion
- [ ] Implement Step 8: Success Message

### Testing & Refinement
- [ ] Run Test Case 1 (Standard Update)
- [ ] Run Test Case 2 (Stage Advancement)
- [ ] Run Test Case 3 (Waiting on Client)
- [ ] Run Test Case 4 (Offline Notes Only)
- [ ] Run Test Case 5 (Multiple Anota√ß√µes)
- [ ] Compare with Notion AI output (3-5 examples)
- [ ] Refine analysis prompt based on results
- [ ] Document any deviations from spec

### Documentation
- [ ] Write README for agent (`docs/2.2-opportunity-advancer-usage.md`)
- [ ] Document command syntax
- [ ] Add troubleshooting section
- [ ] Add example outputs

---

## References

- **Process Documentation:** Notion `/Processos de Neg√≥cio - CRM Workflow - 2.2 - Avan√ßo`
- **AI Configuration:** Notion `/My Notion AI`
- **Technical Architecture:** `docs/arquitetura.md`
- **Roadmap:** `docs/cronograma.md`

---

**Fim da Especifica√ß√£o**
**Vers√£o:** 1.0
**Ready for Implementation:** ‚úÖ
